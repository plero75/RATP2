<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VHP Live Dashboard</title>
    <style>
        :root {
            --bg-color: #0d1b2a;
            --card-bg-color: #1b263b;
            --text-color: #e0e1dd;
            --text-muted-color: #a9a9a9;
            --primary-color: #3a86ff;
            --border-color: rgba(255, 255, 255, 0.1);
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --status-ok-bg: #28a745;
            --status-alert-bg: #dc3545;
            /* IDFM official colors */
            --rer-a-color: #E30520; /* RER A */
            --bus-color: #008D36;   /* Bus */
            --velib-color: #00AEEF; /* V√©lib' */
        }
        * { box-sizing: border-box; }
        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        /* Strict portrait frame 1080x1920 as per spec */
        @media (orientation: portrait) {
          body {
            max-width: 1080px;
            max-height: 1920px;
            margin: 0 auto;
          }
        }
        header, footer {
            flex-shrink: 0;
            padding: 0.5rem 1rem;
            background-color: #000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        header h1 { font-size: 1.5rem; margin: 0; }
        .header-info { text-align: right; }
        #lastUpdate { font-size: 0.75rem; color: var(--text-muted-color); display: block; }
        .traffic-banner {
            padding: 0.5rem; text-align: center; font-weight: bold;
        }
        .traffic-banner.ok { background-color: var(--status-ok-bg); }
        .traffic-banner.alert { background-color: var(--status-alert-bg); }
        main {
            flex-grow: 1;
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1rem;
            padding: 1rem;
            overflow: hidden;
        }
        .grid-col {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            overflow-y: auto;
            padding-right: 8px;
        }
        .grid-col::-webkit-scrollbar { width: 4px; }
        .grid-col::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 2px; }
        .card {
            background-color: var(--card-bg-color);
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        .card h2 { margin: 0 0 1rem 0; font-size: 1.25rem; color: var(--primary-color); }
        footer { border-top: 1px solid var(--border-color); }
        #ticker-slot { font-family: monospace; }
        
        /* Transport Styles */
        .line-pill { font-weight: bold; color: white; padding: 0.2rem 0.6rem; border-radius: 6px; font-size: 1.1rem; }
        .line-pill.rer-a { background-color: var(--rer-a-color); }
        .line-pill.bus { background-color: var(--bus-color); }
        .destination-group {
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-color);
        }
        .destination-group:last-of-type { border-bottom: none; }
        .destination-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        .destination-header .direction-label {
            font-size: 0.7rem;
            color: var(--text-muted-color);
            font-weight: bold;
            text-transform: uppercase;
        }
        .destination-header .destination-name {
            font-size: 1.5rem;
            font-weight: bold;
            color: #f99335;
        }
        .destination-times {
            display: flex;
            align-items: flex-start;
            gap: 1.5rem;
            padding-left: 0.5rem;
        }
        .departure-column {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 0.25rem;
            position: relative;
            min-width: 60px;
        }
        .departure-column:not(:first-child)::before {
            content: '';
            position: absolute;
            left: -0.75rem;
            top: 0;
            bottom: 0;
            width: 1px;
            background-color: var(--text-color);
            opacity: 0.5;
        }
        .minutes { line-height: 1; }
        .minutes .minutes-value {
            font-size: 2.25rem;
            font-weight: 700;
            letter-spacing: -0.05em;
        }
        .minutes .minutes-unit {
            font-size: 0.9rem;
            color: var(--text-muted-color);
            margin-left: 0.25rem;
        }
        .scheduled-time {
            font-size: 1rem;
            color: var(--text-muted-color);
        }
        .status-tag {
            font-size: 0.65rem;
            font-weight: bold;
            padding: 3px 8px;
            border-radius: 6px;
            margin-top: 4px;
            text-transform: uppercase;
            white-space: nowrap;
        }
        .status-tag.imminent {
            background-color: #9d5a2a;
            color: white;
        }
        .status-tag.delayed {
            background-color: #facc15;
            color: #422006;
        }
        .status-tag.cancelled {
            background-color: #2e2e2e;
            color: #a9a9a9;
            text-decoration: line-through;
        }
        .traffic-sub { margin-top: 0.5rem; padding: 0.5rem; border-radius: 4px; font-size: 0.8rem; }
        .traffic-sub.ok { background-color: rgba(40, 167, 69, 0.2); }
        .traffic-sub.alert { background-color: rgba(220, 53, 69, 0.2); }

        /* Weather & Misc */
        .weather-card { display: flex; align-items: center; gap: 1rem; }
        #weather-emoji { font-size: 3rem; }
        #weather-temp { font-size: 2rem; font-weight: bold; }
        #weather-desc { color: var(--text-muted-color); }
        .best-option { display: flex; align-items: center; gap: 0.75rem; }
        .best-option .tag { background: var(--primary-color); color: white; padding: 0.25rem 0.75rem; border-radius: 4px; font-weight: bold; }
        .velib-station { display: flex; justify-content: space-between; padding: 0.25rem 0; color: var(--velib-color); }
        
        /* News */
        .news-card { position: relative; min-height: 100px; }
        #news-carousel { position: relative; height: 100%; }
        .news-card { display: block; position: absolute; inset: 0; padding: 1rem; opacity: 0; transition: opacity 0.5s ease-in-out; }
        .news-card.active { opacity: 1; }
        .news-title { font-weight: bold; margin-bottom: 0.25rem; }
        .news-desc { font-size: 0.85rem; color: var(--text-muted-color); }
        
        /* PMU */
        .pmu-race { display:flex; justify-content:space-between; align-items:center; padding:0.5rem 0; border-bottom:1px solid var(--border-color); }
        .pmu-time { color: var(--text-muted-color); font-weight:bold; }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "date-fns": "https://aistudiocdn.com/date-fns@^4.1.0",
    "date-fns/": "https://aistudiocdn.com/date-fns@^4.1.0/"
  }
}
</script>
</head>
<body>
    <header>
        <h1>Dashboard VHP ‚Äî Paris-Vincennes</h1>
        <div class="header-info">
            <span id="clock">--:--</span>
            <span id="lastUpdate"></span>
        </div>
    </header>

    <div id="traffic-banner" class="traffic-banner">Chargement du trafic...</div>

    <main class="main-grid">
        <div class="grid-col">
            <section class="card">
                <h2>üöÜ RER A ‚Äì Joinville-le-Pont</h2>
                <div id="rer-body">Chargement‚Ä¶</div>
                <div id="rer-traffic" class="traffic-sub" style="display:none;"></div>
            </section>
            <section class="card">
                <h2>üöå Bus ‚Äì Arr√™t Joinville-le-Pont</h2>
                <div id="bus-joinville-body">Chargement‚Ä¶</div>
                <div id="bus-joinville-traffic" class="traffic-sub" style="display:none;"></div>
            </section>
            <section class="card">
                <h2>üöå Bus ‚Äì Arr√™t Hippodrome de Vincennes</h2>
                <div id="bus-hippodrome-body">Chargement‚Ä¶</div>
                <div id="bus-hippodrome-traffic" class="traffic-sub" style="display:none;"></div>
            </section>
            <section class="card">
                <h2>üöå Bus ‚Äì Arr√™t √âcole du Breuil</h2>
                <div id="bus-breuil-body">Chargement‚Ä¶</div>
                <div id="bus-breuil-traffic" class="traffic-sub" style="display:none;"></div>
            </section>
        </div>

        <div class="grid-col">
            <section class="card weather-card">
                <div id="weather-emoji">‚è≥</div>
                <div>
                    <div id="weather-temp">--¬∞</div>
                    <div id="weather-desc">Chargement‚Ä¶</div>
                </div>
            </section>
            <section class="card">
                <h2>üìç Itin√©raire: Hippodrome ‚Üí Joinville RER</h2>
                <div id="best-route">Calcul‚Ä¶</div>
            </section>
            <section class="card">
                <h2>üö≤ V√©lib'</h2>
                <div class="velib-station"><span>Hippodrome</span> <strong id="velib-vincennes">--</strong></div>
                <div class="velib-station"><span>√âcole du Breuil</span> <strong id="velib-breuil">--</strong></div>
            </section>
            <section class="card">
                <h2>üêé Courses PMU du jour</h2>
                <div id="pmu-body">Chargement‚Ä¶</div>
            </section>
            <section class="card news-card">
                <h2>üì∞ Actualit√©s</h2>
                <div id="news-carousel">Chargement‚Ä¶</div>
            </section>
        </div>
    </main>
    
    <footer>
        <div id="ticker-slot">Chargement‚Ä¶</div>
    </footer>
    
    <script>
        // === Constantes & endpoints ===
        const PROXY = "https://ratp-proxy.hippodrome-proxy42.workers.dev/?url=";
        const WEATHER_URL = "https://api.open-meteo.com/v1/forecast?latitude=48.835&longitude=2.45&current_weather=true";
        const RSS_URL = "https://www.lemonde.fr/rss/en_continu.xml";

        const STOP_IDS = {
          RER_A: "STIF:StopArea:SP:43135:",       // Joinville-le-Pont (RER A)
          JOINVILLE: "STIF:StopArea:SP:70640:",   // Arr√™t Joinville-le-Pont (bus)
          HIPPODROME: "STIF:StopArea:SP:463641:", // Hippodrome de Vincennes (bus)
          BREUIL: "STIF:StopArea:SP:463644:"      // √âcole du Breuil (bus)
        };

        const LINES_NAVITIA = { RER_A: "C01742", BUS_77: "C02251", BUS_201: "C01219" };
        const LINES_SIRI = { RER_A: "STIF:Line::A:", BUS_77: "STIF:Line::77:", BUS_201: "STIF:Line::201:" };

        const VELIB_STATIONS = { VINCENNES: "12163", BREUIL: "12128" };

        const WEATHER_CODES = { 0:"Ciel d√©gag√©",1:"Principalement clair",2:"Partiellement nuageux",3:"Couvert",45:"Brouillard",48:"Brouillard givrant",51:"Bruine faible",53:"Bruine",55:"Bruine forte",61:"Pluie faible",63:"Pluie mod√©r√©e",65:"Pluie forte",80:"Averses faibles",81:"Averses mod√©r√©es",82:"Fortes averses",95:"Orages",96:"Orages gr√™le",99:"Orages gr√™le" };

        // √âtat global
        const lineMetaCache = new Map();
        let newsItems = [];
        let currentNews = 0;
        let tickerIndex = 0;
        let tickerData = { timeWeather: "", saint: "", horoscope: "", traffic: "" };
        let signIdx = 0;

        // === Utils ===
        function decodeEntities(str=""){return str.replace(/&nbsp;/gi," ").replace(/&amp;/gi,"&").replace(/&quot;/gi,'"').replace(/&#039;/gi,"'").replace(/&apos;/gi,"'").replace(/&lt;/gi,"<").replace(/&gt;/gi,">").trim();}
        function cleanText(str=""){return decodeEntities(str).replace(/<[^>]*>/g," ").replace(/[<>]/g," ").replace(/\s+/g," ").trim();}
        async function fetchJSON(url, timeout=12000){ try{ const c=new AbortController(); const t=setTimeout(()=>c.abort(),timeout); const r=await fetch(url,{signal:c.signal, cache:"no-store"}); clearTimeout(t); if(!r.ok) throw new Error(`HTTP ${r.status}`); return await r.json(); } catch(e){ console.error("fetchJSON",url,e.message); return null; } }
        async function fetchText(url, timeout=12000){ try{ const c=new AbortController(); const t=setTimeout(()=>c.abort(),timeout); const r=await fetch(url,{signal:c.signal, cache:"no-store"}); clearTimeout(t); if(!r.ok) throw new Error(`HTTP ${r.status}`); return await r.text(); } catch(e){ console.error("fetchText",url,e.message); return ""; } }
        function minutesFromISO(iso){ if(!iso) return null; return Math.max(0, Math.round((new Date(iso).getTime()-Date.now())/60000)); }
        function formatTime(iso){ if(!iso) return "--:--"; return new Date(iso).toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"}); }
        function setClock(){ const el=document.getElementById("clock"); if(el) el.textContent=new Date().toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"}); }
        function setLastUpdate(){ const el=document.getElementById("lastUpdate"); if(el) el.textContent=`Maj ${new Date().toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"})}`; }

        // === R√©f√©rentiel lignes (couleurs IDFM) ===
        function normaliseColor(hex){ if(!hex) return null; const c=hex.toString().trim().replace(/^#/,''); return /^[0-9a-fA-F]{6}$/.test(c)?`#${c}`:null; }
        function fallbackLineMeta(id){ return { id, code:id, color:"#2450a4", textColor:"#fff" }; }
        async function fetchLineMetadata(lineId){
          if(!lineId) return fallbackLineMeta(lineId);
          if(lineMetaCache.has(lineId)) return lineMetaCache.get(lineId);
          const url = "https://data.iledefrance-mobilites.fr/api/explore/v2.1/catalog/datasets/referentiel-des-lignes/records?where=id_line%3D%22"+lineId+"%22&limit=1";
          const data = await fetchJSON(url,10000); let meta=fallbackLineMeta(lineId);
          if(data?.results?.length){ const e=data.results[0]; meta={ id:lineId, code:e.shortname_line||e.name_line||lineId, color: normaliseColor(e.colourweb_hexa)||"#2450a4", textColor: normaliseColor(e.textcolourweb_hexa)||"#fff" }; }
          lineMetaCache.set(lineId, meta); return meta;
        }

        // === Stops parsing ===
        function parseStop(data){
          const visits=data?.Siri?.ServiceDelivery?.StopMonitoringDelivery?.[0]?.MonitoredStopVisit;
          if(!Array.isArray(visits)) return [];
          return visits.map(v=>{
            const mv=v.MonitoredVehicleJourney||{}; const call=mv.MonitoredCall||{};
            const lineRef=mv.LineRef?.value||mv.LineRef||""; const lineId=(lineRef.match(/C\d{5}/)||[null])[0];
            const destDisplay=cleanText(call.DestinationDisplay?.[0]?.value||call.DestinationDisplay?.value||"");
            const expected=call.ExpectedDepartureTime||call.ExpectedArrivalTime||null;
            const aimed=call.AimedDepartureTime||call.AimedArrivalTime||null;
            const status = call.DepartureStatus || call.ArrivalStatus || "onTime";
            const platform = call.DeparturePlatformName?.value || call.ArrivalPlatformName?.value || null;
            const isCancelled = (mv?.Monitored || mv?.Cancelled) === false ? false : (call?.Cancellation || status?.toLowerCase()==="cancelled");
            return { lineId, dest: destDisplay, minutes: minutesFromISO(expected), expectedISO: expected, aimedISO: aimed, status, platform, cancelled: !!isCancelled };
          });
        }

        // === RENDERER NOUVEL AFFICHAGE ===
        function renderDestinationGroup(container, lineMeta, destination, departures) {
            const group = document.createElement('div');
            group.className = 'destination-group';

            const header = document.createElement('div');
            header.className = 'destination-header';
            header.innerHTML = `
                <span class="direction-label">DIRECTION</span>
                <span class="line-pill" style="background-color:${lineMeta.color}; color:${lineMeta.textColor};">${lineMeta.code}</span>
                <span class="destination-name">${destination}</span>
            `;
            group.appendChild(header);

            const timesContainer = document.createElement('div');
            timesContainer.className = 'destination-times';

            departures.slice(0, 3).forEach(dep => {
                if (!dep.expectedISO) return;
                const col = document.createElement('div');
                col.className = 'departure-column';

                const minutesDiv = document.createElement('div');
                minutesDiv.className = 'minutes';
                if (dep.minutes != null) {
                    minutesDiv.innerHTML = `<span class="minutes-value">${dep.minutes}</span><span class="minutes-unit">min</span>`;
                } else {
                    minutesDiv.innerHTML = `<span class="minutes-value">--</span>`;
                }

                const timeDiv = document.createElement('div');
                timeDiv.className = 'scheduled-time';
                timeDiv.textContent = formatTime(dep.expectedISO);
                
                col.appendChild(minutesDiv);
                col.appendChild(timeDiv);

                const status = {
                    imminent: dep.minutes != null && dep.minutes < 2,
                    delayed: dep.status === 'delayed',
                    cancelled: dep.cancelled
                };

                if (status.cancelled) {
                    minutesDiv.style.textDecoration = 'line-through';
                    timeDiv.style.textDecoration = 'line-through';
                    const tag = document.createElement('div');
                    tag.className = 'status-tag cancelled';
                    tag.textContent = 'Supprim√©';
                    col.appendChild(tag);
                } else if (status.imminent) {
                    const tag = document.createElement('div');
                    tag.className = 'status-tag imminent';
                    tag.textContent = 'Imminent';
                    col.appendChild(tag);
                } else if (status.delayed) {
                    const tag = document.createElement('div');
                    tag.className = 'status-tag delayed';
                    tag.textContent = 'Retard√©';
                    col.appendChild(tag);
                }
                
                timesContainer.appendChild(col);
            });

            if (timesContainer.childElementCount === 0) { return; }

            group.appendChild(timesContainer);
            container.appendChild(group);
        }

        // === RER Joinville ===
        async function renderRer(){
          const cont=document.getElementById("rer-body");
          const traf=document.getElementById("rer-traffic");
          if(cont) cont.innerHTML="Chargement‚Ä¶";

          const data=await fetchJSON(PROXY+encodeURIComponent(`https://prim.iledefrance-mobilites.fr/marketplace/stop-monitoring?MonitoringRef=${STOP_IDS.RER_A}`));
          const visits=parseStop(data);

          if(cont) cont.innerHTML="";
          if(!visits.length){ if(cont) cont.textContent="Aucun passage"; return; }

          const byDest = {};
          visits.forEach(v=>{ if(!byDest[v.dest]) byDest[v.dest]=[]; byDest[v.dest].push(v); });
          
          const rerMeta = { id: 'RER_A', code: 'A', color: getComputedStyle(document.documentElement).getPropertyValue('--rer-a-color').trim() || '#E41E26', textColor: '#fff' };

          Object.entries(byDest).forEach(([dest, departures])=>{
            renderDestinationGroup(cont, rerMeta, dest, departures);
          });

          const msgs = await getLineMessages([LINES_SIRI.RER_A]);
          applyTrafficSub(traf, msgs);
        }

        // === BUS par arr√™t (Joinville / Hippodrome / Breuil) ===
        async function renderBusForStop(stopId, containerId, trafficId){
          const cont = document.getElementById(containerId);
          if (!cont) return;
          cont.innerHTML = "Chargement‚Ä¶";

          const data = await fetchJSON(PROXY + encodeURIComponent(
            `https://prim.iledefrance-mobilites.fr/marketplace/stop-monitoring?MonitoringRef=${stopId}`
          ));
          const visits = parseStop(data);

          cont.innerHTML = "";
          if (!visits.length) {
            cont.innerHTML = `<div class="traffic-sub alert">üöß Aucun passage pr√©vu</div>`;
            return;
          }

          const byLine = {};
          visits.forEach(v => {
            if (!byLine[v.lineId]) byLine[v.lineId] = [];
            byLine[v.lineId].push(v);
          });

          for (const [lineId, rows] of Object.entries(byLine)) {
            const meta = await fetchLineMetadata(lineId);

            const byDest = {};
            rows.forEach(r => {
              const dest = r.dest || "Destination inconnue";
              if (!byDest[dest]) byDest[dest] = [];
              byDest[dest].push(r);
            });

            Object.entries(byDest).forEach(([dest, departures]) => {
                renderDestinationGroup(cont, meta, dest, departures);
            });
          }

          const uniqueLineRefs = Object.keys(byLineFromVisits(visits)).map(k=>k);
          const siriLines = uniqueLineRefs.map(id => {
            if (id === LINES_NAVITIA.BUS_77) return LINES_SIRI.BUS_77;
            if (id === LINES_NAVITIA.BUS_201) return LINES_SIRI.BUS_201;
            return null;
          }).filter(Boolean);

          const msgs = await getLineMessages(siriLines);
          const tEl=document.getElementById(trafficId);
          applyTrafficSub(tEl, msgs);
        }

        function byLineFromVisits(visits){
          const agg={}; visits.forEach(v=>{ if(v.lineId) agg[v.lineId]=(agg[v.lineId]||0)+1; }); return agg;
        }

        function applyTrafficSub(el, msgs){
          if(!el) return;
          if(!msgs.length){ el.style.display="none"; el.className="traffic-sub ok"; el.textContent=""; return; }
          el.style.display="block";
          el.className="traffic-sub alert";
          el.textContent = msgs.map(m=>m).join(" ‚Ä¢ ");
        }

        // === Messages trafic (SIRI GeneralMessage) ===
        async function getLineMessages(lineRefs){
          const msgs = [];
          await Promise.all((lineRefs||[]).map(async (lineRef)=>{
            try{
              const url = PROXY + encodeURIComponent(`https://prim.iledefrance-mobilites.fr/marketplace/general-message?LineRef=${encodeURIComponent(lineRef)}`);
              const data = await fetchJSON(url, 12000);
              const deliveries = data?.Siri?.ServiceDelivery?.GeneralMessageDelivery || [];
              deliveries.forEach(del => {
                (del.InfoMessage || []).forEach(msg => {
                  const txt = cleanText(msg?.Content?.Message?.[0]?.MessageText?.[0]?.value || msg?.Content?.Message?.MessageText?.value || msg?.Description || "");
                  if (txt) msgs.push(txt);
                });
              });
            }catch(e){ /* ignore */ }
          }));
          return msgs;
        }

        // === Trajet optimal Hippodrome -> Joinville RER ===
        async function computeBestRouteJoinville(){
          const el=document.getElementById("best-route");
          if(!el) return;
          el.textContent="Calcul‚Ä¶";

          const hippo=await fetchJSON(PROXY+encodeURIComponent(`https://prim.iledefrance-mobilites.fr/marketplace/stop-monitoring?MonitoringRef=${STOP_IDS.HIPPODROME}`));
          const visits=parseStop(hippo);
          const busNext=visits.sort((a,b)=>(a.minutes||99)-(b.minutes||99))[0];
          const nextBusMin = Number.isFinite(busNext?.minutes)? busNext.minutes : null;

          const MARCHE=15, VELIB=6, BUS_TRAVEL=5;
          let velibOK=false;
          try{
            const d=await fetchJSON(PROXY + encodeURIComponent(`https://opendata.paris.fr/api/explore/v2.1/catalog/datasets/velib-disponibilite-en-temps-reel/records?where=stationcode%3D${encodeURIComponent(VELIB_STATIONS.VINCENNES)}&limit=1`));
            const st=d?.results?.[0]; velibOK=((st?.mechanical_bikes||0)+(st?.ebike_bikes||0))>0;
          }catch{}

          const opts=[
            {label:"üö∂ Marche", total:MARCHE, detail:"trajet direct"},
            {label:"üö≤ V√©lib‚Äô", total:velibOK?VELIB:Infinity, detail:velibOK?"v√©lo disponible":"aucun v√©lo"}
          ];
          if(nextBusMin!=null) opts.push({label:"üöå Bus 77/201", total:nextBusMin+BUS_TRAVEL, detail:`attente ${nextBusMin} min + ~${BUS_TRAVEL} min`});
          opts.sort((a,b)=>a.total-b.total);

          const best=opts[0];
          el.innerHTML = `<div class="best-option"><span class="tag">${best.label}</span><div><strong>${best.total===Infinity? "Non recommand√©" : best.total+" min"}</strong> ‚Ä¢ ${best.detail}</div></div>`;
        }

        // === Horoscope cycle ===
        const SIGNS = [ { fr: "B√©lier", en: "Aries" },{ fr: "Taureau", en: "Taurus" },{ fr: "G√©meaux", en: "Gemini" }, { fr: "Cancer", en: "Cancer" },{ fr: "Lion", en: "Leo" },{ fr: "Vierge", en: "Virgo" }, { fr: "Balance", en: "Libra" },{ fr: "Scorpion", en: "Scorpio" },{ fr: "Sagittaire", en: "Sagittarius" }, { fr: "Capricorne", en: "Capricorn" },{ fr: "Verseau", en: "Aquarius" },{ fr: "Poissons", en: "Pisces" } ];
        async function fetchHoroscope(signEn){
          try{
            const url=PROXY+encodeURIComponent(`https://horoscope-app-api.vercel.app/api/v1/get-horoscope/daily?sign=${signEn}&day=today`);
            const res=await fetch(url); if(!res.ok) throw new Error();
            const data=await res.json(); return data?.data?.horoscope_data||"Horoscope indisponible.";
          }catch{return "Erreur horoscope";}
        }
        async function refreshHoroscopeCycle(){
          const {fr,en}=SIGNS[signIdx]; const txt=await fetchHoroscope(en);
          tickerData.horoscope=`üîÆ ${fr} : ${txt}`;
          signIdx=(signIdx+1)%SIGNS.length;
        }

        // === Saint du jour ===
        async function refreshSaint(){
          try{ const d=await fetchJSON("https://nominis.cef.fr/json/nominis.php",10000); if(d?.response?.prenoms) tickerData.saint=`üéÇ Ste ${d.response.prenoms}`; }
          catch{ tickerData.saint=""; }
        }

        // === M√©t√©o ===
        function weatherEmojiFromCode(code){ if([0,1].includes(code)) return "‚òÄÔ∏è"; if([2,3].includes(code)) return "‚õÖ"; if([61,63,65,80,81,82].includes(code)) return "üåßÔ∏è"; if([95,96,99].includes(code)) return "‚õàÔ∏è"; if([45,48].includes(code)) return "üå´Ô∏è"; return "üå§Ô∏è"; }
        async function refreshWeather(){
          const data=await fetchJSON(PROXY + encodeURIComponent(WEATHER_URL),10000);
          const t=document.getElementById("weather-temp"), d=document.getElementById("weather-desc"), e=document.getElementById("weather-emoji");
          if(!data?.current_weather){ if(t) t.textContent="--¬∞"; if(d) d.textContent="Indisponible"; if(e) e.textContent="‚Ä¶"; return; }
          const { temperature, weathercode }=data.current_weather;
          const temp=`${Math.round(temperature)}¬∞C`; const desc=WEATHER_CODES[weathercode]||""; const ico=weatherEmojiFromCode(weathercode);
          if(t) t.textContent=temp; if(d) d.textContent=desc; if(e) e.textContent=ico;
          tickerData.timeWeather=`${ico} ${temp} (${desc})`;
        }

        // === V√©lib ===
        async function refreshVelib(){
          for(const [key,stationId] of Object.entries(VELIB_STATIONS)){
            try{
              const d=await fetchJSON(PROXY + encodeURIComponent(`https://opendata.paris.fr/api/explore/v2.1/catalog/datasets/velib-disponibilite-en-temps-reel/records?where=stationcode%3D${encodeURIComponent(stationId)}&limit=1`));
              const st=d?.results?.[0]; const el=document.getElementById(`velib-${key.toLowerCase()}`); if(!el) continue;
              if(!st){ el.textContent="Indispo"; continue; }
              const mech=st.mechanical_bikes||0, ebike=st.ebike_bikes||0, docks=st.numdocksavailable||0;
              el.textContent=`üö≤${mech} üîå${ebike} üÖøÔ∏è${docks}`;
            }catch{ /* ignore */ }
          }
        }

        // === PMU ===
        async function refreshPMU(){
          const container = document.getElementById('pmu-body');
          if(!container) return;
          container.textContent = 'Chargement‚Ä¶';
const now = new Date();
const day = String(now.getDate()).padStart(2, '0');
const month = String(now.getMonth() + 1).padStart(2, '0');
const year = String(now.getFullYear());
const today = day + month + year;
          const url = PROXY + encodeURIComponent(`https://offline.turfinfo.api.pmu.fr/rest/client/7/programme/${today}`);
          const data = await fetchJSON(url, 15000);
          if(!data){ container.textContent='Indisponible'; return; }
          const courses = data?.programme?.courses || data?.programme?.reunions?.flatMap(r=>r.courses)||[];
          if(!courses.length){ container.textContent = "Aucune course aujourd'hui"; return; }
          const items = courses.slice(0,6).map(c=>{
            const nr = (c.numReunion ?? c.reunion ?? '?');
            const nc = (c.numCourse ?? c.course ?? '?');
            const lib = c.libelleCourse || c.libelle || '';
            const h = c.heureDepart || c.depart || '';
            return `<div class="pmu-race"><strong>R${nr}C${nc}</strong><span>${lib}</span><span class="pmu-time">${h}</span></div>`;
          }).join('');
          container.innerHTML = items;
        }

        // === Actus ===
        async function refreshNews(){
          const xml=await fetchText(PROXY+encodeURIComponent(RSS_URL),15000); let items=[];
          if(xml){ try{ const doc=new DOMParser().parseFromString(xml,"application/xml"); const nodes=[...doc.querySelectorAll("item")].slice(0,6); items=nodes.map(n=>({title:cleanText(n.querySelector("title")?.textContent||""),desc:cleanText(n.querySelector("description")?.textContent||"")})); }catch{} }
          newsItems=items; renderNews();
        }
        function renderNews(){ const cont=document.getElementById("news-carousel"); if(!cont) return; cont.innerHTML=""; if(!newsItems.length){ cont.textContent="Aucune actu"; return; } newsItems.forEach((n,i)=>{ const d=document.createElement("div"); d.className="news-card"+(i===currentNews?" active":""); d.innerHTML=`<div class="news-title">${n.title}</div><div class="news-desc">${n.desc}</div>`; cont.appendChild(d); }); }
        function nextNews(){ if(newsItems.length){ currentNews=(currentNews+1)%newsItems.length; renderNews(); } }

        // === Trafic global (lignes suivies) pour banni√®re principale ===
        async function fetchGeneralMessagesBanner() {
          const ids = Object.values(LINES_SIRI);
          const msgs = await getLineMessages(ids);
          const banner = document.getElementById("traffic-banner");
          if(!banner) return;
          if (!msgs.length) {
            banner.className = "traffic-banner ok";
            banner.textContent = "Trafic normal sur les lignes suivies.";
            tickerData.traffic = "‚úÖ Trafic normal";
          } else {
            banner.className = "traffic-banner alert";
            banner.textContent = msgs.join("  ‚Ä¢  ");
            tickerData.traffic = `‚ö†Ô∏è ${msgs[0]}`;
          }
        }

        // === Ticker (alterne m√©t√©o/heure, f√™te, horoscope, trafic) ===
        function updateTicker(){
          const slot = document.getElementById("ticker-slot");
          if (!slot) return;
          const pool = [ `${new Date().toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"})} ‚Ä¢ ${tickerData.timeWeather}`.trim(), tickerData.saint, tickerData.horoscope, tickerData.traffic ].filter(Boolean);
          if (!pool.length) { slot.textContent = "Chargement‚Ä¶"; return; }
          slot.textContent = pool[tickerIndex % pool.length];
          tickerIndex++;
        }

        // === Boucles ===
        function startLoops(){
          setInterval(setClock, 1000);
          setInterval(renderRer, 60 * 1000);
          setInterval(()=>renderBusForStop(STOP_IDS.JOINVILLE,"bus-joinville-body","bus-joinville-traffic"), 60 * 1000);
          setInterval(()=>renderBusForStop(STOP_IDS.HIPPODROME,"bus-hippodrome-body","bus-hippodrome-traffic"), 60 * 1000);
          setInterval(()=>renderBusForStop(STOP_IDS.BREUIL,"bus-breuil-body","bus-breuil-traffic"), 60 * 1000);
          setInterval(computeBestRouteJoinville, 120 * 1000);
          setInterval(refreshVelib, 3 * 60 * 1000);
          setInterval(refreshWeather, 30 * 60 * 1000);
          setInterval(refreshNews, 15 * 60 * 1000);
          setInterval(nextNews, 12 * 1000);
          setInterval(refreshHoroscopeCycle, 60 * 1000);
          setInterval(refreshSaint, 60 * 60 * 1000);
          setInterval(fetchGeneralMessagesBanner, 5 * 60 * 1000);
          setInterval(refreshPMU, 15 * 60 * 1000);
          setInterval(() => { updateTicker(); setLastUpdate(); }, 10 * 1000);
        }

        // === Init ===
        (async function init(){
          setClock();
          await Promise.allSettled([
            renderRer(),
            renderBusForStop(STOP_IDS.JOINVILLE,"bus-joinville-body","bus-joinville-traffic"),
            renderBusForStop(STOP_IDS.HIPPODROME,"bus-hippodrome-body","bus-hippodrome-traffic"),
            renderBusForStop(STOP_IDS.BREUIL,"bus-breuil-body","bus-breuil-traffic"),
            computeBestRouteJoinville(),
            refreshVelib(),
            refreshWeather(),
            refreshPMU(),
            refreshNews(),
            refreshHoroscopeCycle(),
            refreshSaint(),
            fetchGeneralMessagesBanner(),
          ]);
          updateTicker();
          setLastUpdate();
          startLoops();
        })();
    </script>
</body>
</html>
